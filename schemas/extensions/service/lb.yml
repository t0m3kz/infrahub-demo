---
# yaml-language-server: $schema=https://schema.infrahub.app/infrahub/schema/latest.json
version: "1.0"

nodes:
  - name: VIP
    namespace: Service
    description: "Distributes network traffic via Virtual IPs to servers."
    label: "VIP Service"
    icon: carbon:floating-ip
    include_in_menu: false
    inherit_from:
      - ServiceGeneric
    attributes:
      - name: hostname
        kind: Text
        unique: true
        description: The unique identifier for the VIP.
        # https://stackoverflow.com/questions/11809631/fully-qualified-domain-name-validation
        regex: "(?=^.{1,253}$)(^(((?!-)[a-zA-Z0-9-]{1,63}(?<!-))|((?!-)[a-zA-Z0-9-]{1,63}(?<!-)\\.)+[a-zA-Z]{2,63})$)"  # yamllint disable rule:line-length
        order_weight: 1010
      - name: mode
        kind: Dropdown
        description: The mode in which HAProxy operates for this VIP (HTTP or TCP).
        choices:
          - name: http
            label: HTTP Mode
            description: Layer 7 HTTP mode.
            color: "#A9DFBF"
          - name: tcp
            label: TCP Mode
            description: Layer 4 TCP mode.
            color: "#A9CCE3"
      - name: balance
        kind: Dropdown
        description: The load balancing algorithm to use for this VIP.
        choices:
          - name: roundrobin
            label: Round Robin
            description: Distributes traffic evenly across all available frontends.
            color: "#A9CCE3"
          - name: leastconn
            label: Least Connections
            description: Sends traffic to the frontend with the fewest connections.
            color: "#A9DFBF"
          - name: source
            label: Source IP Hash
            description: Sends same source IP to same frontend.
            color: "#D2B4DE"
          - name: first
            label: First Available
            description: Routes to first available frontend.
            color: "#AFC7F2"
          - name: static-rr
            label: Static Round Robin
            description: Distributes via round-robin.
            color: "#CDEACC"
          - name: uri
            label: URI Hash
            description: Balances by request URI hash.
            color: "#C9A9E3"
          - name: hdr
            label: Header Hash
            description: Balances by HTTP header value.
            color: "#D8E4BC"
          - name: random
            label: Random
            description: Balances traffic randomly across available frontends.
            color: "#CDEACC"
        default_value: roundrobin
        order_weight: 1300
      - name: ssl_certificate
        kind: Text
        description: "SSL certificate name for HTTPS support."
        optional: true
        order_weight: 1500
    relationships:
      - name: vip_ip
        peer: IpamIPAddress
        identifier: vip_service__ip
        cardinality: one
        kind: Attribute
        description: The IP address for this VIP service.
      - name: frontend_servers
        peer: DcimGenericDevice
        optional: false
        cardinality: many
        kind: Generic
        identifier: device_services
        order_weight: 1000
        direction: inbound
      - name: backend_servers
        peer: LoadbalancerServer
        identifier: vip__backend_servers
        cardinality: many
        kind: Generic
        description: Backend servers for VIP service.
      - name: health_checks
        peer: LoadbalancerHealthCheck
        identifier: vip__health_checks
        cardinality: many
        kind: Generic
        description: Health checks for VIP service.

extensions:
  nodes:
    - kind: LoadbalancerServer
      relationships:
        - name: virtual_ips
          label: Virtual IPs
          kind: Component
          cardinality: many
          optional: true
          peer: ServiceVIP
          order_weight: 2000
          identifier: vip__backend_servers
    - kind: LoadbalancerHealthCheck
      relationships:
        - name: health_checks
          label: Health Checks
          kind: Component
          cardinality: many
          optional: true
          peer: ServiceVIP
          order_weight: 2000
          identifier: vip__health_checks
