---
# yaml-language-server: $schema=https://schema.infrahub.app/infrahub/schema/latest.json
version: "1.0"

nodes:
  - name: VirtualFabric
    namespace: Service
    description: Customer virtual fabric deployment with resource limits pattern
    label: "Virtual Fabric Deployment"
    icon: "mdi:cloud-network"
    include_in_menu: false
    uniqueness_constraints:
      - [name__value]
    human_friendly_id:
      - name__value
    display_label: "{{name__value}}"
    order_by: [name__value]
    attributes:
      - name: name
        kind: Text
        computed_attribute:
          kind: Jinja2
          jinja2_template: "{{deployment__name__value}}-{{ customer__name__value }}"  # yamllint disable-line rule:line-length
        read_only: true
        optional: false
        description: "Unique name for the customer deployment"
      - name: status
        kind: Dropdown
        description: "Deployment status"
        order_weight: 1400
        optional: false
        choices:
          - name: planning
            label: Planning
            description: "Deployment is being planned"
            color: "#FFE4B5"
          - name: provisioning
            label: Provisioning
            description: "Resources are being provisioned"
            color: "#FFFF7F"
          - name: active
            label: Active
            description: "Customer is fully deployed and active"
            color: "#7FBF7F"
          - name: maintenance
            label: Maintenance
            description: "Customer deployment is under maintenance"
            color: "#FFD27F"
          - name: decommissioning
            label: Decommissioning
            description: "Customer deployment is being decommissioned"
            color: "#FBFBFB"
          - name: decommissioned
            label: Decommissioned
            description: "Customer deployment has been decommissioned"
            color: "#BFBFBF"
        default_value: planning
    relationships:
      - name: design_pattern
        peer: TopologyVirtualFabricDesign
        cardinality: one
        kind: Attribute
        order_weight: 1000
        optional: false
        description: |
          Design pattern defining resource limits for this deployment
      - name: customer
        peer: OrganizationCustomer
        cardinality: one
        kind: Attribute
        order_weight: 1100
        optional: false
        description: "The customer organization being deployed"
      - name: deployment
        peer: TopologyDataCenter
        cardinality: one
        kind: Attribute
        order_weight: 1000
        optional: false
        on_delete: no-action
        description: "The deployment location for customer services"

extensions:
  nodes:
    - kind: OrganizationCustomer
      relationships:
        - name: virtual_fabric_deployments
          peer: ServiceVirtualFabric
          cardinality: many
          kind: Component
          on_delete: cascade
          optional: true
          order_weight: 2500
          description: "Virtual fabric deployment instances"
    - kind: TopologyDataCenter
      relationships:
        - name: virtual_fabric_deployments
          peer: ServiceVirtualFabric
          cardinality: many
          kind: Component
          optional: true
          order_weight: 2600
          on_delete: cascade
          description: "Customer deployments in this location"
