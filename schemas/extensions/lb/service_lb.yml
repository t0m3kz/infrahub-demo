---
version: "1.0"

nodes:
  - name: Server
    namespace: Loadbalancer
    label: Backend Servers
    icon: mdi:server-plus
    include_in_menu: false
    description: Backend servers for load balancing
    attributes:
      - name: hostname
        kind: Text
        unique: true
        description: Unique hostname for server identification.
        order_weight: 1010
      - name: description
        kind: Text
        optional: true
        order_weight: 1100
      - name: status
        kind: Dropdown
        choices:
          - name: provisioning
            label: Provisioning
            description: "Server is being provisioned."
            color: "#A9DFBF"
          - name: active
            label: Active
            description: "Server is active and operational."
            color: "#A9CCE3"
          - name: maintenance
            label: Maintenance
            description: "Server is under maintenance."
            color: "#FFF2CC"
          - name: disabled
            label: Disabled
            description: "Server has been disabled."
            color: "#D3D3D3"
          - name: deleted
            label: Deleted
            description: "Server has been deleted."
            color: "#FAD7A0"
          - name: outage
            label: Outage
            description: "Server is currently experiencing an outage."
            color: "#F4CCCC"
        default_value: "active"
        order_weight: 1200
    relationships:
      - name: ip_address
        peer: IpamIPAddress
        label: Private IP Address
        identifier: server__ip
        cardinality: one
        kind: Component
        on_delete: cascade
        description: Primary IP address of the server.
        order_weight: 1300

  - name: HealthCheck
    namespace: Loadbalancer
    label: Health-Checks
    icon: tabler:checkup-list
    include_in_menu: false
    description: "Health check associated with a load balancer."
    order_by:
      - check__value
    uniqueness_constraints:
      - [check__value, rise__value, fall__value, timeout__value]
    human_friendly_id:
      - check__value
      - rise__value
      - fall__value
      - timeout__value
    display_label: "{{description__value}}"
    attributes:
      - name: check
        kind: Dropdown
        choices:
          - name: http
            label: "HTTP Check"
            description: "Performs HTTP health checks."
            color: "#A9DFBF"
          - name: tcp
            label: "TCP Check"
            description: "Performs TCP health checks."
            color: "#D8E4BC"
          - name: ssl
            label: "SSL Check"
            description: "Performs SSL health checks."
            color: "#CDEACC"
        description: "The type of health check to perform."
        order_weight: 1100
      - name: rise
        kind: Number
        description: "Successful checks required to mark server UP."
        optional: true
        default_value: 3
        order_weight: 1200
      - name: fall
        kind: Number
        description: "Failed checks required to mark server DOWN."
        optional: true
        default_value: 3
        order_weight: 1300
      - name: timeout
        kind: Number
        label: Timeout (ms)
        description: "Timeout for the health check in milliseconds."
        optional: true
        default_value: 1000
        order_weight: 1500
      - name: description
        kind: Text
        computed_attribute:
          kind: Jinja2
          jinja2_template: "{{ check__value }}-{{ rise__value }}-{{ fall__value }}-{{ timeout__value }}"  # yamllint disable-line rule:line-length
        read_only: true
        optional: false

  - name: LoadBalancer
    namespace: Onprem
    description: "Distributes network traffic via Virtual IPs to servers."
    label: "Load Balancer"
    icon: carbon:floating-ip
    include_in_menu: false
    human_friendly_id:
      - name__value
    inherit_from:
      - PlatformLoadBalancer
      - OnpremGeneric
      - OnpremGenericDevice
    attributes:
      - name: haproxy_mode
        kind: Dropdown
        order_weight: 15
        optional: true
        description: "HAProxy-specific mode (HTTP or TCP)"
        choices:
          - name: http
            label: HTTP Mode
            description: Layer 7 HTTP mode.
            color: "#A9DFBF"
          - name: tcp
            label: TCP Mode
            description: Layer 4 TCP mode.
            color: "#A9CCE3"
      - name: ssl_certificate
        kind: Text
        description: "SSL certificate name for HTTPS support."
        optional: true
        order_weight: 19
    relationships:
      - name: deployment
        peer: TopologyDeployment
        cardinality: one
        kind: Attribute
        order_weight: 500
        optional: false
        on_delete: no-action
        description: "The deployment location for this load balancer"
      - name: frontend_servers
        peer: DcimDevice
        label: Frontend Servers
        optional: true
        cardinality: many
        kind: Component
        identifier: device_service
        on_delete: no-action
        order_weight: 1000
        description: "HAProxy/Nginx frontend servers running the LB software"
extensions:
  nodes:
    - kind: LoadbalancerServer
      relationships:
        - name: backend_pools
          label: Backend Pools
          kind: Generic
          cardinality: many
          optional: true
          peer: ServiceBackendPool
          order_weight: 2100
          identifier: backend_pool__onprem_servers
          description: "Backend pools this server belongs to"
    - kind: LoadbalancerHealthCheck
      relationships:
        - name: vip_services
          label: VIP Services
          kind: Generic
          cardinality: many
          optional: true
          peer: ServiceLoadBalancerVIP
          order_weight: 2100
          identifier: vip_service__health_checks
          description: "VIP services using this health check"
