---
version: "1.0"

nodes:
  - name: VIP
    namespace: Service
    description: "Distributes network traffic via Virtual IPs to servers."
    label: "VIP Service"
    icon: carbon:floating-ip
    include_in_menu: false
    inherit_from:
      - ServiceDeviceGeneric
    attributes:
      - name: name
        kind: Text
        computed_attribute:
          kind: Jinja2
          jinja2_template: "{{ hostname__value}} - {{ vip_ip__address__value }}"
        read_only: true
        optional: false
        unique: true
      - name: hostname
        kind: Text
        unique: true
        description: The unique identifier for the VIP.
        regex: "(?=^.{1,253}$)(^(((?!-)[a-zA-Z0-9-]{1,63}(?<!-))|((?!-)[a-zA-Z0-9-]{1,63}(?<!-)\\.)+[a-zA-Z]{2,63})$)"  # yamllint disable-line rule:line-length
        order_weight: 11
      - name: description
        kind: Text
        order_weight: 12
        description: A brief description of the VIP.
      - name: mode
        kind: Dropdown
        order_weight: 15
        description: HAProxy mode for this VIP (HTTP or TCP).
        choices:
          - name: http
            label: HTTP Mode
            description: Layer 7 HTTP mode.
            color: "#A9DFBF"
          - name: tcp
            label: TCP Mode
            description: Layer 4 TCP mode.
            color: "#A9CCE3"
      - name: balance
        kind: Dropdown
        description: The load balancing algorithm to use for this VIP.
        order_weight: 17
        choices:
          - name: roundrobin
            label: Round Robin
            description: Distributes traffic evenly across frontends.
            color: "#A9CCE3"
          - name: leastconn
            label: Least Connections
            description: Routes to frontend with fewest connections.
            color: "#A9DFBF"
          - name: source
            label: Source IP Hash
            description: Sends same source IP to same frontend.
            color: "#D2B4DE"
          - name: first
            label: First Available
            description: Routes to first available frontend.
            color: "#AFC7F2"
          - name: static-rr
            label: Static Round Robin
            description: Distributes via round-robin.
            color: "#CDEACC"
          - name: uri
            label: URI Hash
            description: Balances by request URI hash.
            color: "#C9A9E3"
          - name: hdr
            label: Header Hash
            description: Balances by HTTP header value.
            color: "#D8E4BC"
          - name: random
            label: Random
            description: Balances traffic randomly across available frontends.
            color: "#CDEACC"
        default_value: roundrobin
      - name: ssl_certificate
        kind: Text
        description: "SSL certificate name for HTTPS support."
        optional: true
        order_weight: 19
    relationships:
      - name: vip_ip
        peer: IpamIPAddress
        identifier: vip_service__ip
        cardinality: one
        kind: Attribute
        description: The IP address for this VIP service.
        order_weight: 22
        on_delete: no-action
      - name: frontend_servers
        peer: DcimDevice
        optional: false
        cardinality: many
        kind: Component
        identifier: device_service
        on_delete: no-action
        order_weight: 1000
      - name: backend_servers
        peer: LoadbalancerServer
        identifier: vip__backend_servers
        cardinality: many
        kind: Generic
        description: Backend servers forwarding VIP traffic.
        order_weight: 1100
        on_delete: no-action
      - name: health_checks
        peer: LoadbalancerHealthCheck
        identifier: vip__health_checks
        cardinality: many
        kind: Generic
        description: Health checks for VIP service.
        order_weight: 1200
        on_delete: no-action
extensions:
  nodes:
    - kind: LoadbalancerServer
      relationships:
        - name: virtual_ips
          label: Virtual IPs
          kind: Component
          cardinality: many
          optional: true
          peer: ServiceVIP
          order_weight: 2000
          identifier: vip__backend_servers
    - kind: LoadbalancerHealthCheck
      relationships:
        - name: health_checks
          label: Health Checks
          kind: Component
          cardinality: many
          optional: true
          peer: ServiceVIP
          order_weight: 2000
          identifier: vip__health_checks
