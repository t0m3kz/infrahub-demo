---
# yaml-language-server: $schema=https://schema.infrahub.app/infrahub/schema/latest.json
version: "1.0"

nodes:

  - name: Server
    namespace: Loadbalancer
    label: Backend Servers
    icon: mdi:server-plus
    include_in_menu: false
    description: Backen servers
    attributes:
      - name: hostname
        kind: Text
        unique: true
        description: Unique hostname for server identification.
        order_weight: 1010
      - name: description
        kind: Text
        optional: true
        order_weight: 1100
      - name: status
        kind: Dropdown
        choices:
          - name: provisioning
            label: Provisioning
            description: "Device is being provisioned."
            color: "#A9DFBF"
          - name: active
            label: Active
            description: "Device is active and operational."
            color: "#A9CCE3"
          - name: maintenance
            label: Maintenance
            description: "Device is under maintenance."
            color: "#FFF2CC"
          - name: disabled
            label: Disabled
            description: "Device has been disabled."
            color: "#D3D3D3"
          - name: deleted
            label: Deleted
            description: "Device has been deleted."
            color: "#FAD7A0"
          - name: outage
            label: Outage
            description: "Device is currently experiencing an outage."
            color: "#F4CCCC"
        default_value: "active"
        order_weight: 1200
    relationships:
      - name: ip_address
        peer: IpamIPAddress
        label: Private IP Address
        identifier: server__ip
        cardinality: one
        kind: Component
        on_delete: cascade
        description: Primary IP address of the server.
        order_weight: 1300
      - name: virtual_ips
        label: VIPs
        state: absent
        peer: LoadbalancerVIP
        identifier: vip__backend
        cardinality: many
        kind: Component
        description: The list of VIP using this server as Backend.

  - name: HealthCheck
    namespace: Loadbalancer
    label: Health-Checks
    icon: tabler:checkup-list
    menu_placement: LoadbalancerVIP
    include_in_menu: false
    description: "Configuration for a health check associated with a VIP."
    order_by:
      - check__value
    uniqueness_constraints:
      - [description__value]
    human_friendly_id:
      - description__value
    display_label: "{{description__value}}"
    attributes:
      - name: check
        kind: Dropdown
        choices:
          - name: http
            label: "HTTP Check"
            description: "Performs HTTP health checks."
            color: "#A9DFBF"
          - name: tcp
            label: "TCP Check"
            description: "Performs TCP health checks."
            color: "#D8E4BC"
          - name: ssl
            label: "SSL Check"
            description: "Performs SSL health checks."
            color: "#CDEACC"
        description: "The type of health check to perform."
        order_weight: 1100
      - name: rise
        kind: Number
        description: "Successful checks required to mark VIP UP."
        optional: true
        default_value: 3
        order_weight: 1200
      - name: fall
        kind: Number
        description: "Failed checks required to mark VIP DOWN."
        optional: true
        default_value: 3
        order_weight: 1300
      - name: timeout
        kind: Number
        label: Timeout (ms)
        description: "Timeout for the health check in milliseconds."
        optional: true
        default_value: 1000
        order_weight: 1500
      - name: description
        kind: Text
        computed_attribute:
          kind: Jinja2
          jinja2_template: "{{ check__value }}-{{ rise__value }}-{{ fall__value }}-{{ timeout__value }}"  # yamllint disable-line rule:line-length
        read_only: true
        optional: false
# extensions:
#   nodes:
#     # IPAM Extensions
#     - kind: IpamIPAddress
#       relationships:
#         - name: server
#           kind: Component
#           peer: ServerBase
#           identifier: server__priv_ip
#           description: "Server using this IP"
#           cardinality: one
#           label: Server
#           order_weight: 1600
