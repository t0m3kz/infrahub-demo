!
! A10 Thunder Load Balancer Configuration
! Device: {{ name }}
! Type: {{ lb_type|default('software') }} Load Balancer
! Scheme: {{ scheme|default('internal') }}
! Management IP: {{ loadbalancer_config.management_ip }}
! Device Role: {{ loadbalancer_config.device_role }}
! Device Status: {{ loadbalancer_config.device_status }}
!

! System Configuration
hostname {{ name }}

! SNMP Configuration
snmp-server community public RO
snmp-server location {{ location | default('Data Center') }}
snmp-server contact {{ contact | default('Network Admin') }}

! NTP Configuration
ntp server 0.pool.ntp.org
ntp server 1.pool.ntp.org

! DNS Configuration
ip dns primary 8.8.8.8
ip dns secondary 8.8.4.4

! Syslog Configuration
logging host {{ syslog_server | default('127.0.0.1') }}
logging level information

{%- if vips %}
{%- for vip in vips %}
{%- if vip.backend_servers %}

!
! Service Group configuration for {{ vip.hostname }}
!
slb service-group {{ vip.hostname | replace('.', '_') | replace('-', '_') }}_sg {{ vip.mode | upper }}
{%- if vip.balance == 'roundrobin' %}
    method round-robin
{%- elif vip.balance == 'leastconn' %}
    method least-connection
{%- elif vip.balance == 'source' %}
    method src-ip-hash
{%- elif vip.balance == 'random' %}
    method weighted-rr
{%- else %}
    method round-robin
{%- endif %}

{%- if vip.health_checks %}
{%- for check in vip.health_checks %}
    {%- if check.check_type == 'http' %}
    health-check http
    health-check http-port {{ vip.port | default(80) }}
    {%- elif check.check_type == 'tcp' %}
    health-check tcp
    {%- elif check.check_type == 'ssl' %}
    health-check ssl
    {%- endif %}
    health-check interval {{ check.timeout | default(5000) | int // 1000 }}
    health-check retry {{ check.rise | default(3) }}
    health-check up-retry {{ check.rise | default(3) }}
{%- endfor %}
{%- else %}
    health-check tcp
    health-check interval 5
    health-check retry 3
{%- endif %}

{%- for server in vip.backend_servers %}

!
! Server configuration for {{ server.hostname }}
!
slb server {{ server.hostname | replace('.', '_') | replace('-', '_') }} {{ server.ip_address }}
    port {{ server.port | default(80) }} {{ vip.mode | upper }}
    {%- if server.weight %}
    weight {{ server.weight }}
    {%- endif %}

!
! Add server to service group
!
slb service-group {{ vip.hostname | replace('.', '_') | replace('-', '_') }}_sg
    member {{ server.hostname | replace('.', '_') | replace('-', '_') }} {{ server.port | default(80) }}
{%- endfor %}

!
! Virtual Server configuration for {{ vip.hostname }}
!
slb virtual-server {{ vip.hostname | replace('.', '_') | replace('-', '_') }}_vs {{ vip.vip_ip }}
{%- if vip.ssl_certificate %}
    port 443 {{ vip.mode | upper }}
        source-nat auto
        service-group {{ vip.hostname | replace('.', '_') | replace('-', '_') }}_sg
        template client-ssl {{ vip.hostname | replace('.', '_') | replace('-', '_') }}_ssl
    !
    port 80 HTTP
        source-nat auto
        template http {{ vip.hostname | replace('.', '_') | replace('-', '_') }}_redirect
{%- else %}
    port {{ vip.port | default(80) }} {{ vip.mode | upper }}
        source-nat auto
        service-group {{ vip.hostname | replace('.', '_') | replace('-', '_') }}_sg
{%- endif %}

{%- if vip.ssl_certificate %}
!
! SSL Template for {{ vip.hostname }}
!
slb template client-ssl {{ vip.hostname | replace('.', '_') | replace('-', '_') }}_ssl
    cert {{ vip.ssl_certificate }}
    key {{ vip.ssl_certificate }}_key
    cipher-suite "ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256"
    version 30

!
! HTTP Redirect Template for {{ vip.hostname }}
!
slb template http {{ vip.hostname | replace('.', '_') | replace('-', '_') }}_redirect
    redirect https://{{ vip.hostname }}
{%- endif %}

{%- if vip.mode == 'http' or vip.mode == 'HTTP' %}
!
! HTTP Template for {{ vip.hostname }}
!
slb template http {{ vip.hostname | replace('.', '_') | replace('-', '_') }}_http
    insert-client-ip
    {%- if vip.session_persistence %}
    persistence cookie {{ vip.hostname | replace('.', '_') | replace('-', '_') }}_cookie
    {%- endif %}
{%- endif %}

{%- if vip.connection_limit %}
!
! Connection Limit Template for {{ vip.hostname }}
!
slb template connection-reuse {{ vip.hostname | replace('.', '_') | replace('-', '_') }}_conn
    limit-per-server {{ vip.connection_limit }}
{%- endif %}

{%- endif %}
{%- endfor %}
{%- endif %}

!
! Access-list for management
!
access-list 10 permit {{ loadbalancer_config.management_network | default('10.0.0.0') }} {{ loadbalancer_config.management_netmask | default('0.255.255.255') }}
access-list 10 deny any

!
! Enable management access
!
enable-management service ssh
    acl-v4 10
enable-management service https
    acl-v4 10
enable-management service snmp
    acl-v4 10

!
! Session Logging (optional)
!
{%- if enable_session_logging %}
ip nat pool logging-pool {{ logging_pool_start | default('10.0.0.100') }} {{ logging_pool_end | default('10.0.0.200') }} netmask /24
ip nat inside source-list 20 pool logging-pool
{%- endif %}

!
! High Availability (if configured)
!
{%- if ha_config %}
vrrp vrid {{ ha_config.vrid | default(1) }}
    blade-parameters
        priority {{ ha_config.priority | default(100) }}
    floating-ip {{ ha_config.floating_ip }}
{%- endif %}

!
! Statistics and Monitoring
!
slb common
    stats-data-enable
    extended-stats
    entity server
    entity service-group
    entity virtual-server

!
! Save configuration
!
write memory

!
! End of A10 Thunder Configuration
!
