{#- Dell SONiC Leaf Configuration -#}
! Hostname configuration
hostname {{ hostname }}

! Enable required features
nv overlay evpn
feature ospf
feature bgp
feature interface-vlan
feature vn-segment-vlan-based
feature nv overlay

{#- VLAN Configuration -#}
{%- for vlan in vlans %}
vlan {{ vlan.vlan_id }}
  name {{ vlan.name or 'VLAN_' + vlan.vlan_id|string }}
  vn-segment {{ vlan.get('vni', vlan.vlan_id) }}
{% endfor %}

{#- All Interfaces (Physical and Virtual) -#}
{% for interface in interfaces %}
interface {{ interface.name }}
{%- if interface.description %}
  description {{ interface.description }}
{%- endif %}
{%- if interface.ip_addresses %}
{%- for ip in interface.ip_addresses %}
  ip address {{ ip.address }}
{%- endfor %}
{%- endif %}
{%- if interface.vlans %}
  switchport
  switchport mode access
  switchport access vlan {{ interface.vlans[0] }}
{%- endif %}
{%- if interface.get('ospf') %}
  ip router ospf {{ ospf[0].process_id or 1 }} area {{ interface.ospf.area }}
{%- endif %}
  no shutdown
!
{% endfor %}

{%- if ospf %}
{#- OSPF Configuration -#}
{%- for ospf_config in ospf %}
router ospf {{ ospf_config.process_id or 1 }}
  router-id {{ ospf_config.router_id.split('/')[0] }}
  reference-bandwidth {{ ospf_config.reference_bandwidth or 100000 }}
  passive-interface default
{%- for interface in interfaces %}
{%- if interface.get('ospf') %}
  no passive-interface {{ interface.name }}
{%- endif %}
{%- endfor %}
!
{% endfor %}
{%- endif %}

{%- if bgp %}
{#- BGP Configuration -#}
{%- for bgp_config in bgp %}
router bgp {{ bgp_config.local_as.asn }}
  router-id {{ bgp_config.router_id.address.split('/')[0] }}
  no bgp default ipv4-unicast
  distance bgp 20 200 200
  maximum-paths 4 ecmp 64
{%- for session in bgp_config.sessions %}
  neighbor {{ session.remote_ip.address.split('/')[0] }} remote-as {{ session.remote_as.asn }}
  neighbor {{ session.remote_ip.address.split('/')[0] }} update-source Loopback0
  neighbor {{ session.remote_ip.address.split('/')[0] }} send-community extended
  neighbor {{ session.remote_ip.address.split('/')[0] }} maximum-routes 0
{%- endfor %}
  address-family ipv4
    redistribute connected route-map RM-CONN-2-BGP
{%- for session in bgp_config.sessions %}
    neighbor {{ session.remote_ip.address.split('/')[0] }} activate
{%- endfor %}
  address-family evpn
{%- for session in bgp_config.sessions %}
    neighbor {{ session.remote_ip.address.split('/')[0] }} activate
{%- endfor %}
!
{% endfor %}
{%- endif %}

{%- if vxlan and vxlan.enabled %}
!
! VXLAN Configuration with Microsegmentation (VRF-aware VNIs)
!
{%- if vxlan.microsegmentation and vxlan.microsegmentation.enabled %}
! Microsegmentation enabled: {{ vxlan.microsegmentation.vrf_count }} VRF(s) for tenant isolation
{%- endif %}
!
interface {{ vxlan.vxlan_interface }}
{%- if vxlan.vtep.ipv4 %}
  source {{ vxlan.vtep.source_interface }}
{%- endif %}
{%- if vxlan.l2_vni_mappings %}
  !
  ! L2 VNI Mappings (VLAN segments)
{%- for mapping in vxlan.l2_vni_mappings %}
  map vni {{ mapping.vni }} vlan {{ mapping.vlan_id }}
{%- endfor %}
{%- endif %}
{%- if vxlan.l3_vni_mappings %}
  !
  ! L3 VNI Mappings (VRF segments for microsegmentation)
{%- for mapping in vxlan.l3_vni_mappings %}
  map vni {{ mapping.l3_vni }} vrf {{ mapping.vrf_name }}
{%- endfor %}
{%- endif %}
  no shutdown
!
{%- if vxlan.l3_vni_mappings %}
!
! VRF Definitions (Microsegmentation)
!
{%- for mapping in vxlan.l3_vni_mappings %}
vrf {{ mapping.vrf_name }}
  description {{ mapping.description | default('Tenant VRF for microsegmentation') }}
!
{%- endfor %}
{%- endif %}
{%- if vxlan.vrf_loopbacks %}
!
! VRF Loopback Interfaces
!
{%- for loopback in vxlan.vrf_loopbacks %}
interface {{ loopback.name }}
  description VRF {{ loopback.vrf }} L3VNI {{ loopback.l3_vni }}
  vrf forwarding {{ loopback.vrf }}
{%- if loopback.ip %}
  ip address {{ loopback.ip }}/32
{%- endif %}
  no shutdown
!
{%- endfor %}
{%- endif %}
{%- if vxlan.evpn and vxlan.evpn.enabled %}
!
! EVPN Configuration (FRR)
!
router bgp {{ bgp[0].local_as.asn }}
  address-family l2vpn evpn
    advertise-all-vni
{%- if vxlan.l2_vni_mappings %}
    !
    ! L2 VNI EVPN Configuration
{%- for mapping in vxlan.l2_vni_mappings %}
    vni {{ mapping.vni }}
      rd {{ vxlan.evpn.rd_format | replace('{vni}', mapping.vni | string) }}
      route-target import {{ bgp[0].local_as.asn }}:{{ mapping.vni }}
      route-target export {{ bgp[0].local_as.asn }}:{{ mapping.vni }}
{%- endfor %}
{%- endif %}
{%- if vxlan.l3_vni_mappings %}
    !
    ! L3 VNI EVPN Configuration (VRF-aware)
{%- for mapping in vxlan.l3_vni_mappings %}
    vni {{ mapping.l3_vni }}
      rd {{ vxlan.evpn.rd_format | replace('{vni}', mapping.l3_vni | string) }}
      route-target import {{ bgp[0].local_as.asn }}:{{ mapping.l3_vni }}
      route-target export {{ bgp[0].local_as.asn }}:{{ mapping.l3_vni }}
{%- endfor %}
{%- endif %}
  exit-address-family
!
{%- endif %}
{%- endif %}

! Configure route-maps
route-map RM-CONN-2-BGP permit 10
  match interface Loopback0

! End of configuration
