---
apiVersion: infrahub.app/v1
kind: Object
spec:
  kind: CoreNodeTriggerRule
  data:

    # - name: trigger-dc-generator-on-merge
    #   branch_scope: "default_branch"
    #   node_kind: TopologyDataCenter
    #   mutation_action: "created"
    #   action: run-dc-generator

    - name: trigger-dc-generator-update-super-spines
      branch_scope: "other_branches"
      node_kind: TopologyDataCenter
      mutation_action: "updated"
      action: run-dc-generator
      matches:
        kind: CoreNodeTriggerAttributeMatch
        data:
          - attribute_name: amount_of_super_spines
            value_match: any

    - name: trigger-dc-generator-update-design-pattern
      branch_scope: "other_branches"
      node_kind: TopologyDataCenter
      mutation_action: "updated"
      action: run-dc-generator
      matches:
        kind: CoreNodeTriggerRelationshipMatch
        data:
          - relationship_name: design_pattern
            modification_type: updated

    - name: trigger-dc-generator-update-super-spine-template
      branch_scope: "other_branches"
      node_kind: TopologyDataCenter
      mutation_action: "updated"
      action: run-dc-generator
      matches:
        kind: CoreNodeTriggerRelationshipMatch
        data:
          - relationship_name: super_spine_template
            modification_type: updated

    - name: trigger-dc-generator-update-pod
      branch_scope: "other_branches"
      node_kind: TopologyDataCenter
      mutation_action: updated
      action: run-dc-generator
      matches:
        kind: CoreNodeTriggerRelationshipMatch
        data:
          - relationship_name: children
            modification_type: updated

    # Pod triggers on creation (DC generator sets checksum) or updates
    - name: trigger-pod-generator-on-create
      branch_scope: "other_branches"
      node_kind: TopologyPod
      mutation_action: "created"
      action: run-pod-generator

    - name: trigger-pod-generator-update-checksum
      branch_scope: "other_branches"
      node_kind: TopologyPod
      mutation_action: "updated"
      action: run-pod-generator
      matches:
        kind: CoreNodeTriggerAttributeMatch
        data:
          - attribute_name: checksum
            value_match: any

    - name: trigger-pod-generator-update-index
      branch_scope: "other_branches"
      node_kind: TopologyPod
      mutation_action: "updated"
      action: run-pod-generator
      matches:
        kind: CoreNodeTriggerAttributeMatch
        data:
          - attribute_name: index
            value_match: any

    - name: trigger-pod-generator-update-amount-of-spines
      branch_scope: "other_branches"
      node_kind: TopologyPod
      mutation_action: "updated"
      action: run-pod-generator
      matches:
        kind: CoreNodeTriggerAttributeMatch
        data:
          - attribute_name: amount_of_spines
            value_match: any

    - name: trigger-pod-generator-update-deployment
      branch_scope: "other_branches"
      node_kind: TopologyPod
      mutation_action: "updated"
      action: run-pod-generator
      matches:
        kind: CoreNodeTriggerAttributeMatch
        data:
          - attribute_name: deployment_type
            value_match: any


    # Racks trigger on creation (skips if no checksum, waits for update)
    # or on checksum update (when pod/middle rack generator sets it)
    # Checksum is NEVER set manually - always calculated by generators
    - name: trigger-rack-generator-on-create
      branch_scope: "other_branches"
      node_kind: LocationRack
      mutation_action: "created"
      action: run-rack-generator

    - name: trigger-rack-generator-update-checksum
      branch_scope: "other_branches"
      node_kind: LocationRack
      mutation_action: "updated"
      action: run-rack-generator
      matches:
        kind: CoreNodeTriggerAttributeMatch
        data:
          - attribute_name: checksum
            value_match: any

    - name: trigger-rack-generator-update-index
      branch_scope: "other_branches"
      node_kind: LocationRack
      mutation_action: "updated"
      action: run-rack-generator
      matches:
        kind: CoreNodeTriggerAttributeMatch
        data:
          - attribute_name: index
            value_match: any

    - name: trigger-rack-generator-update-rack-type
      branch_scope: "other_branches"
      node_kind: LocationRack
      mutation_action: "updated"
      action: run-rack-generator
      matches:
        kind: CoreNodeTriggerAttributeMatch
        data:
          - attribute_name: rack_type
            value_match: any

    - name: trigger-rack-generator-update-templates
      branch_scope: "other_branches"
      node_kind: LocationRack
      mutation_action: "updated"
      action: run-rack-generator
      matches:
        kind: CoreNodeTriggerRelationshipMatch
        data:
          - relationship_name: fabric_templates
            modification_type: updated

    # Device decommission: when status set to decommissioned
    - name: trigger-device-decommission
      branch_scope: "other_branches"
      node_kind: DcimPhysicalDevice
      mutation_action: "updated"
      action: run-decommission-device
      matches:
        kind: CoreNodeTriggerAttributeMatch
        data:
          - attribute_name: status
            value_match: decommissioned

    # Pod decommission: when status set to decommissioned
    - name: trigger-pod-decommission
      branch_scope: "other_branches"
      node_kind: TopologyPod
      mutation_action: "updated"
      action: run-decommission-pod
      matches:
        kind: CoreNodeTriggerAttributeMatch
        data:
          - attribute_name: status
            value_match: decommissioned
